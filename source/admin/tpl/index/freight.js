app.controller("freightCtrl",["$scope","_jiyin","dataToURL","$state",function(t,i,e){t.postage=[],t.set={},t.provinceList=[],t.setPostage=[],t.allowPush=[],t.adcodes=[];var s=new AMap.DistrictSearch({level:"country",showbiz:!1,subdistrict:1});t.initAddress=function(e){s.search(e,function(e,s){if("complete"==e)if(s.districtList.length>0){angular.forEach(s.districtList[0].districtList,function(i){t.provinceList.push(i)});var c=t.provinceList.splice(22,1);t.provinceList.unshift(c[0])}else i.msg("e","获取省级行政区失败")})},t.initAddress("中国"),t.provincfe_name="四川省",t.provincfe_code="12323",t.getCity=function(e,c){t.provincfe_name=e,t.provincfe_code=c,s.search(c,function(e,s){if("complete"==e)if(t.cityList=[],s.districtList.length>0){var c=document.getElementById("city_tpl").innerHTML;$("#city").html(template(c,{data:s.districtList[0].districtList}))}else i.msg("e","获取省级行政区失败")})},t.getCity("四川省","510000"),t.getDistrict=function(e,c){s.search(e,function(s,o){-1==t.adcodes.indexOf(e)?(t.adcodes.push(e),t.allowPush=!0):t.allowPush=!1,"complete"==s&&(o.districtList.length>0?(console.log(o.districtList[0]),console.log(o.districtList[0].districtList),o.districtList[0].districtList||(t.newDistrictObj={},o.districtList[0].districtList=[],t.newDistrictObj.adcode=o.districtList[0].adcode,t.newDistrictObj.citycode=o.districtList[0].citycode,t.newDistrictObj.level="district",t.newDistrictObj.name=o.districtList[0].name,t.newDistrictObj.price=o.districtList[0].price,o.districtList[0].districtList.push(t.newDistrictObj)),t.getFreightRule(o.districtList[0].districtList,e,c,t.allowPush)):i.msg("e","获取省级行政区失败"))})},t.getDistrict("成都市","510100"),$(document).on("click",".cityTr",function(){var i=$(this).data("city-name"),e=$(this).data("city-code");t.getDistrict(i,e)}),t.getFreightRule=function(e,s,c,o){i.dataGet("admin/postage_admin/get_all").then(function(i){if(i.success){angular.forEach(e,function(e){t.set.province=t.provincfe_name,t.set.province_code=t.provincfe_code,t.set.city=s,t.set.city_code=c,t.set.district=e.name,t.set.district_code=e.adcode,angular.forEach(i.data,function(t){t.district_code||(t.district_code=t.city_code,t.disrict=t.city)}),o?(angular.forEach(i.data,function(i){i.district_code==e.adcode&&""!=e.price&&(e.price=angular.copy(i.price),t.set.price=angular.copy(i.price),t.set.setPostage=!0)}),t.setPostage.push(angular.copy(t.set)),t.set={}):(t.set={},angular.forEach(t.setPostage,function(t){return t.district_code&&null!=t.district_code||(t.district_code=t.city_code,t.district=t.city),t.district_code==e.adcode&&t.city_code==c&&t.price?void(e.price=t.price):void 0}))}),t.set={};var r=document.getElementById("district_tpl").innerHTML;$(".district").html(template(r,{data:e}))}else if(o){angular.forEach(e,function(i){t.set.city=angular.copy(s),t.set.city_code=angular.copy(c),t.set.district=angular.copy(i.name),t.set.district_code=angular.copy(i.adcode),t.setPostage.push(angular.copy(t.set))});var r=document.getElementById("district_tpl").innerHTML;$(".district").html(template(r,{data:e}))}else{t.district_list=[],angular.forEach(t.setPostage,function(i){i.city_code==c&&t.district_list.push(i)});var r=document.getElementById("district_tpl").innerHTML;$(".district").html(template(r,{data:t.district_list}))}})},$(document).on("change",".postage-price",function(){var i=$(this),e="",s="";angular.forEach(t.provinceList,function(t){t.adcode.substr(0,2)==i.data("district-code").toString().substr(0,2)&&(e=t.name,s=t.adcode)}),angular.forEach(t.setPostage,function(t){t.district_code==i.data("district-code")?(t.province_code=s,t.province=e,t.price=i.val(),$(".postage-condition").each(function(t,e){$(e).data("district-code")==i.data("district-code")}),t.setPostage=!0):!t.district_code||null==t.district_code}),console.log(t.setPostage)}),t.submitPostageRule=function(){t.submitResult=[],angular.forEach(t.setPostage,function(i){t.submitResult.push(angular.copy(i))}),console.log(t.submitResult);for(var s=0;s<t.submitResult.length;s++)t.submitResult[s].hasOwnProperty("setPostage")&&delete t.submitResult[s].setPostage,t.submitResult[s].city_code==t.submitResult[s].district_code&&(t.submitResult[s].district_code=null,t.submitResult[s].district=null),(""==t.submitResult[s].price||void 0==t.submitResult[s].price)&&(t.submitResult.splice(s,1),s--);i.dataPost("admin/postage_admin/set_postage",e({postage:JSON.stringify(t.submitResult)})).then(function(t){t.success?i.msg("s","邮费设置成功"):i.msg("e","邮费设置失败")})}}]);