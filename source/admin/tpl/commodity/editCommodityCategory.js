app.controller("editPackagesCtrl",["$rootScope","$scope","_jiyin","dataToURL","$stateParams","$state",function(t,i,o,e,a,n){i.is_admin=t.is_admin,i.infoList={},i.role_id="",i.operate=angular.copy(a.operate),i.infoList.name=angular.copy(a.category),i.infoList.index_id=angular.copy(a.id),i.infoList.agent_id=angular.copy(a.agent_id),i.infoList.agent_name=angular.copy(a.agent_name),i.infoList.color=angular.copy(a.color)?angular.copy(a.color):"#fff",$("#color").val(i.infoList.color),i.$watch("currentUser.role_id",function(o){"30"==o&&(i.infoList.agent_name=t.currentUser.username,i.infoList.agent_id=t.currentUser.id,i.role_id=t.currentUser.role_id)}),i.url="edit"==i.operate?!0:!1,"edit"==i.operate&&(i.get_category_by_name=function(){o.dataPost("admin/agent_admin/get_category_by_name",e({index_id:i.infoList.index_id})).then(function(t){t?(i.selecteCommodityList=t.data,i.category=t.data[0].category):(o.msg("e",t.msg),i.discount=[])})},i.urlWC=SITE_URL+"weixin/agent/entrance?agent_id="+i.infoList.agent_id+"&uid=xxxxx&cid="+i.infoList.name,i.get_category_by_name()),$("#colorpicker").farbtastic("#color"),$("#color").focus(function(){$("#colorpicker").show()}),$("#color").blur(function(){$("#colorpicker").hide()}),i.delete_commodity=function(t,a){if("edit"==i.operate){if(confirm("确定删除吗？")){for(var n=0;n<i.selecteCommodityList.length;n++)i.selecteCommodityList[n].id==t&&(i.selecteCommodityList.splice(n,1),n--);o.dataPost("admin/agent_admin/delete_agent_home_by_id",e({id:t,agent_index_id:a})).then(function(t){t?i.get_category_by_name():o.msg("e",t.msg)})}}else if(confirm("确定删除该商品吗？")){for(var n=0;n<i.selecteCommodityList.length;n++)i.selecteCommodityList[n].id==t&&(i.selecteCommodityList.splice(n,1),i.commodity_ids.splice(n,1),n--);angular.forEach(i.selecteCommodityList,function(t,i){t.rank=i+1}),i.commodity_list=angular.copy(i.selecteCommodityList),i.idStr=i.commodity_ids.join(",")}},i.getAgent=function(){i.title="添加代理商",o.modal({tempUrl:"/source/admin/tpl/modal/modal-agentAddCommodity.html",tempCtrl:"agentAddCommodityCtrl",ok:i.addAgent,size:"lg",params:{title:i.title,ael:"add"}})},i.addAgent=function(t){i.infoList.agent_name=t.name,i.infoList.agent_id=t.id},i.add_commodity=function(){return i.infoList.agent_id?(i.title="添加代理商商品",void o.modal({tempUrl:"/source/admin/tpl/modal/modal-editCommodityCategory.html",tempCtrl:"commodityCategoryCtrl",ok:i.add,size:"lg",params:{title:i.title,infoList:i.discount,roleList:i.roleList,ael:"add",agent_id:i.infoList.agent_id}})):void o.msg("e","请选择代理商")},i.commodity_ids=[],i.commodity_list=[],i.selecteCommodities=[],i.selecteCommodityList=[],i.deleteList=[],i.ids=[],i.add=function(t){if("edit"==i.operate){i.ids=[],i.commodity_ids=[],i.commodity_list=[],i.package={},i.packages_detail=[],angular.forEach(t,function(t){(0==i.commodity_ids.length||-1==i.commodity_ids.indexOf(t.id))&&(t.commodity_price=t.cash_price,t.number=1,i.commodity_ids.push(t.id),i.commodity_list.push(t))});var n=i.selecteCommodityList&&""!=i.selecteCommodityList?i.selecteCommodityList.length+1:1;if(""==i.selecteCommodityList||void 0==i.selecteCommodityList?i.selecteCommodityList=angular.copy(i.commodity_list):(angular.forEach(i.selecteCommodityList,function(t){var o=i.commodity_ids.indexOf(t.agent_commodity_id);if(-1!=o){for(var e=0;e<i.commodity_list.length;e++)i.commodity_list[e].id==t.agent_commodity_id&&i.commodity_list.splice(e,1);i.commodity_ids.splice(o,1)}}),angular.forEach(i.commodity_list,function(t){i.selecteCommodityList.push(t)})),0==i.commodity_ids.length)return void o.msg("e","已经添加过该商品");angular.forEach(i.selecteCommodityList,function(t){i.ids.push(t.id)}),angular.forEach(i.selecteCommodityList,function(t,i){t.rank=i+1}),angular.forEach(i.commodity_list,function(t){t.rank=angular.copy(n),i.package.agent_commodity_id=t.id,i.package.rank=t.rank,i.package.agent_index_id=angular.copy(a.id),i.packages_detail.push(angular.copy(i.package)),n++}),i.packages_detail=JSON.stringify(i.packages_detail),o.dataPost("admin/agent_admin/add_agent_commodity_category",e({commodity_category:i.packages_detail})).then(function(t){console.log(t),t.success?i.get_category_by_name():o.msg("e",t.msg)})}else"add"==i.operate&&(angular.forEach(t,function(t){(0==i.commodity_ids.length||-1==i.commodity_ids.indexOf(t.id))&&(t.number=1,i.commodity_ids.push(t.id),i.commodity_list.push(t))}),0!=i.selecteCommodityList.length&&angular.forEach(i.selecteCommodityList,function(t){-1!=JSON.stringify(i.commodity_list).indexOf(t.id)&&angular.forEach(i.commodity_list,function(o,e){o.id==t.id&&(i.commodity_list.splice(e,1),i.commodity_ids.splice(t.id,1))})}),angular.forEach(i.commodity_list,function(t){i.selecteCommodityList.push(angular.copy(t))}),angular.forEach(i.selecteCommodityList,function(t,i){t.rank=i+1}),i.idStr=i.commodity_ids.join(","))},i.submit=function(){if(i.infoList.color=$("#color").val(),!i.infoList.name)return void o.msg("e","请填写主页名称名称");var t=/^[A-Za-z]+$/;if(!t.test(i.infoList.name))return void o.msg("e","主页名称必须全是英文");if(!i.infoList.color)return void o.msg("e","请填写主页配色");if("add"==i.operate){if(!i.selecteCommodityList||i.selecteCommodityList==[])return void o.msg("e","请添加商品");i.submitData=[],i.submitSub={},angular.forEach(i.selecteCommodityList,function(t){i.submitSub.commodity_id=t.commodity_id,i.submitSub.commodity_specification_id=t.id,i.submitSub.name=i.infoList.name,i.submitSub.color=i.infoList.color,i.submitSub.rank=t.rank,i.submitSub.agent_commodity_id=t.id,i.submitSub.agent_id=i.infoList.agent_id,i.submitData.push(angular.copy(i.submitSub))}),o.dataPost("admin/agent_admin/add_agent_category",e({commodity_category:JSON.stringify(i.submitData)})).then(function(t){1==t.success?(o.msg("s",t.msg),n.go("app.agentCommodityCategory")):o.msg("e",t.msg)})}else o.dataPost("admin/agent_admin/update_agent_index",e({name:i.infoList.name,color:i.infoList.color,index_id:i.infoList.index_id})).then(function(t){1==t.success?(o.msg("s",t.msg),n.go("app.agentCommodityCategory")):o.msg("e",t.msg)})},i.changeSort=function(t,a,n){var d;d=t[a],t[a]=t[a+n],t[a+n]=d;var m=[],s=[];return angular.forEach(i.selecteCommodityList,function(t){m[m.length]=t.id,s[s.length]=t.rank}),m=m.toString(),o.dataPost("admin/Agent_admin/adjust_rank",e({id:m})).then(function(t){1==t.success?(o.msg("s","调整成功"),i.get_category_by_name()):o.msg("e",t.msg)}),!1},i.reset=function(){i.discount=[]},i.back=function(){history.go(-1)}}]);