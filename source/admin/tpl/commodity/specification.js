app.controller("specificationCtrl",["$scope","$state","_jiyin","dataToURL","$stateParams",function(t,i,e,a,o){t.commodity_id=o.commodity_id,t.specificationList={},t.inputPage=1,t.picList=[],t.keyword="",t.list={},t.commodity_type=o.commodity_type,t.dataShow=!0,"com"==o.type?(t.flag=!0,t.isPoint=!1):"int"==o.type&&(t.flag=!1,t.isPoint=!0),t.$on("attachment_ids",function(i,e){t.list.attachment_ids||(t.list.attachment_ids=[]),t.list.attachment_ids.push(e)}),t.$on("path",function(i,e){null==t.picList&&(t.picList=[]);var a=[];a.path=e,t.picList.push(a)}),t.getData=function(){e.dataPost("admin/commodity_admin/paginate_for_specification/"+t.inputPage+"/10/"+t.commodity_id,a({keyword:t.keyword})).then(function(i){i.success?(t.dataShow=!0,t.totalPage=i.total_page,t.specificationList=i.data):(t.totalPage=1,t.dataShow=!1,e.msg("e",i.msg))})},t.getData(),$("#search").keydown(function(i){13==i.keyCode&&t.getData()}),t.delete=function(i){e.dataPost("admin/commodity_admin/delete_commodity_specification",a({specification_id:i})).then(function(i){i.success?(e.msg("s",i.msg),t.getData()):e.msg("e",i.msg)})},t.show=function(){t.title="增加",t.ael="add",t.list={},t.url=!1,t.list.commodity_id=o.commodity_id,t.open=!0,t.getStatus(),t.$broadcast("open",{open:t.open}),$("#add").modal("show")},t.edit=function(i){t.title="编辑",t.picList=[],t.ael="edit",t.list=angular.copy(i),t.url=!0,t.urlPC=SITE_URL+"commodity/index/"+i.commodity_id+"/"+i.id,t.urlWC=SITE_URL+"weixin/index/commodity_detail/"+i.commodity_id+"/"+i.id,t.getThumbnail(),t.getStatus(),t.open=!0,t.$broadcast("open",{open:t.open}),$("#add").modal("show")},t.detectionManage=function(i){$("#detection").modal("show"),t.getTemplate(),t.getSpecificationTemplate(i.id),t.currentId=i.id,t.add=[]},getPackType=function(){e.dataGet("admin/system_code_admin/get_by_type/packagetype").then(function(i){t.packList=i?i:[]})},getPackType(),t.getTemplate=function(){e.dataPost("admin/detection_template_admin/get_template_by_page",a({page:1,page_size:999})).then(function(i){i.success?t.templates=i.data:(t.templates=[],e.msg("e",i.msg))})},t.getSpecificationTemplate=function(i){e.dataPost("admin/commodity_admin/paginate_commodity_specification_template/1/999",a({specification_id:i})).then(function(i){i.success?t.specificationTemplates=i.data:(t.specificationTemplates=[],e.msg("e",i.msg))})},t.addTemplate=function(){if(!t.add.template_id)return void e.msg("e","请选择检测模板");if(!t.add.number)return void e.msg("e","请输入检测项目数量");if(t.add.number&&t.add.template_id)for(var i=0;i<t.templates.length;i++)if(t.templates[i].id==t.add.template_id&&parseInt(t.add.number)>parseInt(t.templates[i].project_count))return void e.msg("e","检测项目数量最多"+t.templates[i].project_count+"项，请重新输入");e.dataPost("admin/commodity_admin/add_commodity_specification_template",a({specification_id:t.currentId,template_id:t.add.template_id,project_num:t.add.number})).then(function(i){i.success?(e.msg("s",i.msg),t.getSpecificationTemplate(t.currentId),t.add=[]):e.msg("e",i.msg)})},t.deleteTemplate=function(i){e.dataGet("admin/commodity_admin/delete_commodity_specification_template/"+i).then(function(i){i.success?(e.msg("s",i.msg),t.getSpecificationTemplate(t.currentId)):e.msg("e",i.msg)})},t.add_commodity=function(){e.modal({tempUrl:"/source/admin/tpl/modal/modal-agentAddCommodity.html",tempCtrl:"agentAddCommodityCtrl",ok:t.add,size:"lg",params:{infoList:t.discount,roleList:t.roleList,is_point:t.isPoint,ael:"add",select:"s"}})},t.add=function(i){var e=i[0].commodity_center_id?i[0].specification_center_name:i[0].specification_name;t.infoList.commodity_name=i[0].commodity_name+" "+e+" "+i[0].package_type_name,t.infoList.recommend_specification_id=i[0].id,t.infoList.recommend_commodity_id=i[0].commodity_id},t.recommend=function(i){t.specification_id=i.id,t.recommendList=[],t.getRecommendList(),t.infoList=[],t.infoList.commodity_id=i.commodity_id,t.infoList.specification_id=i.id,$("#recommend_modal").modal("show")},t.addRecommend=function(){e.dataPost("admin/commodity_admin/add_commodity_recommend_commodity",a({commodity_id:t.infoList.commodity_id,specification_id:t.infoList.specification_id,recommend_commodity_id:t.infoList.recommend_commodity_id,recommend_specification_id:t.infoList.recommend_specification_id})).then(function(i){i.success?(t.infoList=[],e.msg("s",i.msg),t.getRecommendList()):e.msg("e",i.msg)})},t.getRecommendList=function(){e.dataPost("admin/commodity_admin/get_commodity_recommend_commodity",a({specification_id:t.specification_id})).then(function(i){i.success?t.recommendList=i.data:(e.msg("e",i.msg),t.recommendList=[])})},t.deleteRecommend=function(i){confirm("确认删除此相关推荐吗?")&&e.dataPost("admin/commodity_admin/delete_commodity_recommend_commodity",a({id:i})).then(function(i){(i.success=!0)?(e.msg("s","删除成功"),t.getRecommendList()):e.msg("e",i.msg)})},t.removePic=function(i,o){confirm("确定删除该图片吗?")&&(i?e.dataPost("admin/commodity_admin/delete_thumbnail",a({id:i})).then(function(i){i.success&&(t.picList.splice(o,1),t.getThumbnail())}):t.picList.splice(o,1))},t.getThumbnail=function(){t.list.id&&e.dataPost("admin/commodity_admin/get_specification_thumbnail",a({commodity_id:t.list.commodity_id,commodity_specification_id:t.list.id})).then(function(i){i.success&&(t.picList=i.data)})},t.getStatus=function(){e.dataPost("admin/system_code_admin/get_by_type/commodity_specification_status").then(function(i){t.statusList="add"==t.ael?i.slice(0,2):i})},t.getEvaluateBySpecification=function(t){i.go("app.evaluate",{commodity_id:t.commodity_id,type:o.type,specification_id:t.id})},t.ok=function(){var i="";if(i="add"==t.ael?"admin/commodity_admin/add_commodity_specification":"admin/commodity_admin/update_commodity_specification",null==t.list.commodity_specification_name&&!t.list.name)return void e.msg("e","商品规格名称不能为空");if(!t.list.market_price)return void e.msg("e","市场价格不能为空");if(!t.list.selling_price)return void e.msg("e","销售价格不能为空");if(!t.list.status_id)return void e.msg("e","商品状态不能为空");t.list.attachment_ids&&(t.list.attachment_ids=t.list.attachment_ids.toString());var o={id:t.list.id,name:t.list.name,market_price:t.list.market_price,selling_price:t.list.selling_price,status_id:t.list.status_id,packagetype:t.list.packagetype,points:t.list.points,goodsunit:t.list.goodsunit,commodity_id:t.list.commodity_id,attachment_ids:t.list.attachment_ids},n={id:t.list.commodity_id,name:null!=t.list.commodity_specification_name?t.list.commodity_specification_name:t.list.name,market_price:t.list.market_price,selling_price:t.list.selling_price,status_id:t.list.status_id,packagetype:t.list.packagetype,points:t.list.points,goodsunit:t.list.goodsunit,attachment_ids:t.list.attachment_ids};if("add"==t.ael)var d=n;else var d=o;e.dataPost(i,a(d)).then(function(i){1==i.success?(e.msg("s",i.msg),t.getData(),$("#add").modal("hide")):e.msg("e",i.msg)})},t.upload=function(i){t.title="上传规格图片",e.modal({tempUrl:"/source/admin/tpl/modal/modal-uploadCommodityPic.html",tempCtrl:"uploadCommodityPicCtrl",ok:t.uploadPic,size:"lg",params:{title:t.title,id:i.id,path:i.path,ael:"edit"}})},t.uploadPic=function(i){console.log(i),e.dataPost("admin/commodity_admin/upload_commodity_specification_attachment",a({id:i.id,attachment_id:i.attachment_id})).then(function(i){1==i.success?(e.msg("s",i.msg),t.getData()):e.msg("e",i.error)})},t.nextPage=function(){t.inputPage<t.totalPage?(t.inputPage++,t.getData()):e.msg("e","当前是最后一页")},t.previousPage=function(){t.inputPage>1?(t.inputPage--,t.getData()):e.msg("e","当前是第一页")},t.firstPage=function(){t.inputPage=1,t.getData()},t.lastPage=function(){t.inputPage=t.totalPage,t.getData()},t.selectPage=function(i){t.inputPage=i,t.getData()}}]),app.controller("speFileUploadCtrl",["$scope","FileUploader","_jiyin","dataToURL",function(t,i,e,a){t.attachment_ids=[];var o=t.uploader=new i({url:SITE_URL+"attachment/up_attachment",removeAfterUpload:!0,queueLimit:5});t.$on("open",function(t,i){1==i.open&&o.clearQueue()}),o.filters.push({name:"customFilter",fn:function(){return this.queue.length<6}}),t.upload=function(i){e.fileMd5(i._file).then(function(n){e.dataPost("attachment/check_md5",a({md5_code:n.md5Code})).then(function(e){1==e.exist?(t.attachment_ids=[],t.attachment_ids.push(e.attachment_id),t.$emit("attachment_ids",t.attachment_ids),t.$emit("path",e.path),i.file.size=i._file.size,i.progress=100,i.isSuccess=!0,i.isUploaded=!0,i.uploader.progress+=100/o.queue.length):i.upload()})})},t.uploadAll=function(){angular.forEach(o.queue,function(i){e.fileMd5(i._file).then(function(n){e.dataPost("attachment/check_md5",a({md5_code:n.md5Code})).then(function(e){1==e.exist?(t.attachment_ids=[],t.attachment_ids.push(e.attachment_id),t.$emit("attachment_ids",t.attachment_ids),t.$emit("path",e.path),i.file.size=i._file.size,i.progress=100,i.isSuccess=!0,i.isUploaded=!0,o.progress+=100/o.queue.length):i.upload()})})})},o.onSuccessItem=function(i,e){t.attachment_ids=[],t.attachment_ids.push(e.attachment_id),t.$emit("attachment_ids",t.attachment_ids),t.$emit("path",e.url)},t.$on("clearQueue",function(){o.clearQueue()})}]);