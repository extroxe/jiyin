app.directive("autoFocus",function(){return function(e,t){t[0].focus()}}),app.controller("codeManagementCtrl",["$scope","_jiyin","dataToURL","$state","$stateParams",function(e,t,a,n,i){e.reportList={},e.inputPage=1,e.keyword="",e.province="",e.list={},e.open=!1,e.check=!1,e.state=2,e.register_start_time="",e.register_end_time="",e.checkList=new Array,e.checkState=["全部","已提交","未提交","全部"],e.totalPage=1,e.checkNum=0,e.allCheckNum=10,e.back=function(){window.history.go(-1)},e.checked=function(){e.check=!e.check,e.check?angular.forEach(e.reportList,function(e){e.checked=!0}):angular.forEach(e.reportList,function(e){e.checked=!1})},e.listcheck=function(){e.checkNum=0,angular.forEach(e.reportList,function(t){t.checked&&e.checkNum++})},e.$watch("checkNum",function(t){e.check=t<e.allCheckNum?!1:!0}),e.stateFlagSub=function(){e.state=1,e.checkState[0]=e.checkState[1]},e.stateFlagNsub=function(){e.state=0,e.checkState[0]=e.checkState[2]},e.stateFlagReset=function(){e.state=2,e.checkState[0]=e.checkState[3]},e.getData=function(){t.dataPost("admin/report_admin/get_report_by_page_for_sample",a({keyword:e.keyword,attachment:e.state,has_written:2,start_create_time:e.register_start_time,end_create_time:e.register_end_time,page:e.inputPage,page_size:10})).then(function(t){t.success&&(e.reportList=t.data,e.totalPage=t.total_page,e.allCheckNum=e.reportList.length,e.totalNum=t.total,angular.forEach(e.reportList,function(e){e.checked=!1}))})},e.getData(),e.search=function(){e.inputPage=1,t.dataPost("admin/report_admin/get_report_by_page_for_sample",a({keyword:e.keyword,attachment:e.state,has_written:2,start_create_time:e.register_start_time,end_create_time:e.register_end_time,page:e.inputPage,page_size:10})).then(function(t){e.check=!1,e.reportList=t.data,e.allCheckNum=e.reportList.length,e.totalPage=t.total_page?t.total_page:1,e.totalNum=t.total,angular.forEach(e.reportList,function(e){e.checked=!1})})},$("#filter").keydown(function(t){13==t.keyCode&&e.search()}),e.download=function(){e.checkList=[],angular.forEach(e.reportList,function(t){t.checked&&e.checkList.push(t.number)}),e.checkList.length>0?window.open(SITE_URL+"admin/report_admin/download_barcode?data="+e.checkList):t.msg("e","请选择要下载的报告")},e.$on("attachment_id",function(t,a){e.list.attachment_id=a}),e.add=function(){e.list={},e.flag=!0,e.open=!0,$("#reportModal").modal("show"),$("#focus_number")[0].focus(),e.$broadcast("open",{open:e.open})},e.edit=function(t){e.list=t,e.province=t.province,e.flag=!1,e.open=!0,$("#reportModal").modal("show"),e.$broadcast("open",{open:e.open})},e.delete=function(n){confirm("确定删除此报告吗?")&&t.dataPost("admin/report_admin/delete",a({id:n.id})).then(function(a){1==a.success?(t.msg("s","删除成功"),e.getData()):t.msg("e","删除失败")})},e.ok=function(){var n;if(!e.list.number)return void t.msg("e","报告编号不能为空");if(!e.list.name)return void t.msg("e","名字不能为空");if(!e.list.gender)return void t.msg("e","性别不能为空");if(!e.list.age)return void t.msg("e","年龄不能为空");if(!e.list.phone)return void t.msg("e","电话不能为空");if(!e.list.identity_card)return void t.msg("e","身份证号不能为空");if(!e.list.attachment_id)return void t.msg("e","还没有上传报告");var o=/^1(3|4|5|7|8)\d{9}$/,c=/^(\d{6})(\d{4})(\d{2})(\d{2})(\d{3})([0-9]|X|x)$/;return e.list.phone&&0==o.test(e.list.phone)?void t.msg("e","手机号不符合规则"):e.list.identity_card&&0==c.test(e.list.identity_card)?void t.msg("e","身份证号不符合规则"):(n=1==e.flag?"admin/report_admin/add":"admin/report_admin/update",e.list.order_commodity_id=i.id,void t.dataPost(n,a(e.list)).then(function(a){1==a.success?(t.msg("s",a.msg),e.getData(),$("#reportModal").modal("hide"),e.open=!1):t.msg("e",a.msg)}))},e.nextPage=function(){e.inputPage<e.totalPage?(e.check=!1,e.inputPage++,e.getData()):t.msg("e","当前是最后一页")},e.previousPage=function(){e.inputPage>1?(e.check=!1,e.inputPage--,e.getData()):t.msg("e","当前是第一页")},e.firstPage=function(){1==e.totalPage?t.msg("e","当前是第一页"):(e.check=!1,e.inputPage=1,e.getData())},e.lastPage=function(){1==e.totalPage?t.msg("e","当前是最后一页"):(e.check=!1,e.inputPage=e.totalPage,e.getData())};var o;e.selectPage=function(a){clearTimeout(o),o=setTimeout(function(){1==e.totalPage?t.msg("e","当前是最后一页"):(e.check=!1,e.inputPage=a,e.getData())},500)}}]),app.controller("reportFileUploadCtrl",["$scope","FileUploader","_jiyin","dataToURL",function(e,t,a,n){var i=e.uploader=new t({url:SITE_URL+"attachment/upload_report"});e.$on("open",function(e,t){1==t.open&&i.clearQueue()}),i.filters.push({name:"customFilter",fn:function(){return this.queue.length<2}}),e.upload=function(t){return i.queue.length>1?void a.msg("e","只能上传一个文件"):void a.fileMd5(t._file).then(function(o){a.dataPost("attachment/check_md5",n({md5_code:o.md5Code})).then(function(a){1==a.exist?(e.$emit("attachment_id",a.attachment_id),t.file.size=t._file.size,t.progress=100,t.isSuccess=!0,t.isUploaded=!0,t.uploader.progress+=100/i.queue.length):t.upload()})})},e.uploadAll=function(){return i.queue.length>1?void a.msg("e","只能上传一个文件"):void angular.forEach(i.queue,function(t){a.fileMd5(t._file).then(function(o){a.dataPost("attachment/check_md5",n({md5_code:o.md5Code})).then(function(a){1==a.exist?(e.$emit("attachment_id",a.attachment_id),t.file.size=t._file.size,t.progress=100,t.isSuccess=!0,t.isUploaded=!0,i.progress+=100/i.queue.length):t.upload()})})})},i.onSuccessItem=function(t,a){e.$emit("attachment_id",a.attachment_id)},e.$on("clearQueue",function(){i.clearQueue()})}]);