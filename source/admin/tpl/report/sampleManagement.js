app.directive("autoFocus",function(){return function(e,t){t[0].focus()}}),app.controller("sampleManagementCtrl",["$scope","_jiyin","dataToURL","$state","$stateParams",function(e,t,a,r,i){e.reportList={},e.inputPage=1,e.pageSize=10,e.keyword="",e.province="",e.list={},e.open=!1,e.check=!1,e.state=2,e.register_start_time="",e.register_end_time="",e.checkList=new Array,e.checkState=["全部","已填写","未填写","全部"],e.totalPage=1,e.checkNum=0,e.allCheckNum=10,e.select_all=!1,e.checkedArray=[],e.inputNumber="",e.back=function(){window.history.go(-1)},e.selectAll=function(){e.select_all?(e.checkedArray=[],angular.forEach(e.reportList,function(t){t.checked=!0,e.checkedArray.push(t.id)})):(e.checkedArray=[],angular.forEach(e.reportList,function(e){e.checked=!1}))},e.selectOne=function(){angular.forEach(e.reportList,function(t){var a=e.checkedArray.indexOf(t.id);-1===a&&t.checked?e.checkedArray.push(t.id):-1===a||t.checked||e.checkedArray.splice(a,1)}),e.select_all=e.reportList.length===e.checkedArray.length,console.log(e.select_all)},e.checked=function(){e.check=!e.check,e.check?angular.forEach(e.reportList,function(e){e.checked=!0}):angular.forEach(e.reportList,function(e){e.checked=!1})},e.listcheck=function(){e.checkNum=0,angular.forEach(e.reportList,function(t){t.checked&&e.checkNum++})},e.$watch("checkNum",function(t){e.check=t<e.allCheckNum?!1:!0}),e.stateFlagSub=function(){e.state=1,e.checkState[0]=e.checkState[1]},e.stateFlagNsub=function(){e.state=0,e.checkState[0]=e.checkState[2]},e.stateFlagReset=function(){e.state=2,e.checkState[0]=e.checkState[3]},e.getData=function(){t.dataPost("admin/report_admin/get_report_by_page_for_sample",a({keyword:e.keyword,attachment:2,has_written:e.state,start_create_time:e.register_start_time,end_create_time:e.register_end_time,page:e.inputPage,page_size:e.pageSize})).then(function(t){t.success&&(e.reportList=t.data,e.totalPage=t.total_page,e.totalNum=t.total,e.allCheckNum=e.reportList.length,angular.forEach(e.reportList,function(e){e.checked=!1}))})},e.getData(),e.search=function(){e.inputPage=1,t.dataPost("admin/report_admin/get_report_by_page_for_sample",a({keyword:e.keyword,attachment:2,has_written:e.state,start_create_time:e.register_start_time,end_create_time:e.register_end_time,page:e.inputPage,page_size:e.pageSize})).then(function(t){e.select_all=!1,e.check=!1,e.reportList=t.data,e.allCheckNum=e.reportList.length,e.totalPage=t.total_page?t.total_page:1,e.totalNum=t.total,angular.forEach(e.reportList,function(e){e.checked=!1})})},$("#filter").keydown(function(t){13==t.keyCode&&e.search()}),e.downloadSamples=function(){var t="?";void 0!=e.register_start_time&&""!=e.register_start_time&&(t+="start_create_time="+e.register_start_time+"&"),void 0!=e.register_end_time&&""!=e.register_end_time&&(t+="end_create_time="+e.register_end_time+"&"),void 0!=e.state&&e.state>=0&&(t+="has_written="+e.state+"&"),void 0!=e.keyword&&""!=e.keyword&&(t+="keyword="+e.keyword+"&"),0!=e.checkedArray.length&&(t+="report_id="+e.checkedArray.join("_")),window.open(SITE_URL+"admin/report_admin/download_report"+t)},e.downloadSamplesForCSV=function(){var t="?";void 0!=e.register_start_time&&""!=e.register_start_time&&(t+="start_create_time="+e.register_start_time+"&"),void 0!=e.register_end_time&&""!=e.register_end_time&&(t+="end_create_time="+e.register_end_time+"&"),void 0!=e.state&&e.state>=0&&(t+="has_written="+e.state+"&"),void 0!=e.keyword&&""!=e.keyword&&(t+="keyword="+e.keyword+"&"),0!=e.checkedArray.length&&(t+="report_id="+e.checkedArray.join("_")),window.open(SITE_URL+"admin/report_admin/download_report_for_csv"+t)},e.inputToExport=function(){e.inputNumber=null,$("#reportExportModal").modal("show")},e.downloadSamplesFromInput=function(t){var a=e.inputNumber.replace(/\t/g,"");a=$.trim(a),$("#real_number").val(a.replace(/\n/g,"_")),$("#is_excel").val(t),document.getElementById("reportInputForm").submit()},e.$on("attachment_id",function(t,a){e.list.attachment_id=a}),e.add=function(){e.list={},e.flag=!0,e.open=!0,$("#reportModal").modal("show"),$("#focus_number")[0].focus(),e.$broadcast("open",{open:e.open})},e.edit=function(t){e.list=t,e.province=t.province,e.flag=!1,e.open=!0,$("#reportModal").modal("show"),e.$broadcast("open",{open:e.open})},e.delete=function(r){confirm("确定删除此报告吗?")&&t.dataPost("admin/report_admin/delete",a({id:r.id})).then(function(a){1==a.success?(t.msg("s","删除成功"),e.getData()):t.msg("e","删除失败")})},e.ok=function(){var r;if(!e.list.number)return void t.msg("e","报告编号不能为空");if(!e.list.name)return void t.msg("e","名字不能为空");if(!e.list.gender)return void t.msg("e","性别不能为空");if(!e.list.age)return void t.msg("e","年龄不能为空");if(!e.list.phone)return void t.msg("e","电话不能为空");if(!e.list.identity_card)return void t.msg("e","身份证号不能为空");if(!e.list.attachment_id)return void t.msg("e","还没有上传报告");var n=/^1(3|4|5|7|8)\d{9}$/,o=/^(\d{6})(\d{4})(\d{2})(\d{2})(\d{3})([0-9]|X|x)$/;return e.list.phone&&0==n.test(e.list.phone)?void t.msg("e","手机号不符合规则"):e.list.identity_card&&0==o.test(e.list.identity_card)?void t.msg("e","身份证号不符合规则"):(r=1==e.flag?"admin/report_admin/add":"admin/report_admin/update",e.list.order_commodity_id=i.id,void t.dataPost(r,a(e.list)).then(function(a){1==a.success?(t.msg("s",a.msg),e.getData(),$("#reportModal").modal("hide"),e.open=!1):t.msg("e",a.msg)}))},e.nextPage=function(){e.inputPage<e.totalPage?(e.check=!1,e.inputPage++,e.getData()):t.msg("e","当前是最后一页")},e.previousPage=function(){e.inputPage>1?(e.check=!1,e.inputPage--,e.getData()):t.msg("e","当前是第一页")},e.firstPage=function(){1==e.totalPage?t.msg("e","当前是第一页"):(e.check=!1,e.inputPage=1,e.getData())},e.lastPage=function(){1==e.totalPage?t.msg("e","当前是最后一页"):(e.check=!1,e.inputPage=e.totalPage,e.getData())};var n;e.selectPage=function(a){clearTimeout(n),n=setTimeout(function(){1==e.totalPage?t.msg("e","当前是最后一页"):(e.check=!1,e.inputPage=a,e.getData())},500)}}]),app.controller("reportFileUploadCtrl",["$scope","FileUploader","_jiyin","dataToURL",function(e,t,a,r){var i=e.uploader=new t({url:SITE_URL+"attachment/upload_report"});e.$on("open",function(e,t){1==t.open&&i.clearQueue()}),i.filters.push({name:"customFilter",fn:function(){return this.queue.length<2}}),e.upload=function(t){return i.queue.length>1?void a.msg("e","只能上传一个文件"):void a.fileMd5(t._file).then(function(n){a.dataPost("attachment/check_md5",r({md5_code:n.md5Code})).then(function(a){1==a.exist?(e.$emit("attachment_id",a.attachment_id),t.file.size=t._file.size,t.progress=100,t.isSuccess=!0,t.isUploaded=!0,t.uploader.progress+=100/i.queue.length):t.upload()})})},e.uploadAll=function(){return i.queue.length>1?void a.msg("e","只能上传一个文件"):void angular.forEach(i.queue,function(t){a.fileMd5(t._file).then(function(n){a.dataPost("attachment/check_md5",r({md5_code:n.md5Code})).then(function(a){1==a.exist?(e.$emit("attachment_id",a.attachment_id),t.file.size=t._file.size,t.progress=100,t.isSuccess=!0,t.isUploaded=!0,i.progress+=100/i.queue.length):t.upload()})})})},i.onSuccessItem=function(t,a){e.$emit("attachment_id",a.attachment_id)},e.$on("clearQueue",function(){i.clearQueue()})}]);