"use strict";app.controller("modalPostageCtrl",["$scope","$modalInstance","_jiyin","params","FileUploader","dataToURL",function(e,i,t,o){e.levelIds=[],e.categoryIds=[],e.categoryObject={},e.commodity_ids=[],e.commodity_list=[],e.ids=[],e.setCommodity={},e.set_commodity||(e.set_commodity=[]),e.infoList={},null!=o.infoList.order_cost&&0!=o.infoList.order_cost?o.infoList.type=1:null!=o.infoList.order_commodity_amount&&0!=o.infoList.order_commodity_amount&&(o.infoList.type=2),e.selecteCommodityList=[],angular.forEach(o.infoList.commodity_list,function(i){i.id=i.option_id,i.name=i.option_name,e.selecteCommodityList.push(i)}),e.set_commodity=angular.copy(e.selecteCommodityList),console.log(e.set_commodity),e.selecteCommodityListByCategory=[],angular.forEach(o.infoList.category_list,function(i){i.id=i.option_id,i.name=i.option_name,e.categoryIds.push(i.option_id),e.selecteCommodityListByCategory.push(i)}),console.log(e.set_commodity),e.infoList=angular.copy(o.infoList),null!=e.infoList.order_commodity_amount&&0!=e.infoList.order_commodity_amount?e.infoList.type="2":(null!=e.infoList.order_cost&&0!=e.infoList.order_cost||"add"==o.ael)&&(e.infoList.type="1"),e.title=o.title,e.ael=o.ael,"add"==e.ael&&(e.infoList.level_list=[],e.infoList.terminal_list=[],e.infoList.level_scope=1,e.infoList.terminal_type_scope=1,e.allLevelChecked=!0,e.allTerminalChecked=!0),e.infoList.commodity_scope||(e.infoList.commodity_scope=1),e.getRole=function(){t.dataPost("admin/system_code_admin/get_by_type/role").then(function(i){e.roleList=i})},e.getRole(),e.getLevel=function(){t.dataPost("admin/level_admin/get_level").then(function(i){angular.forEach(i.data,function(i){e.infoList.level_list.length>0&&0==e.infoList.level_scope?(angular.forEach(e.infoList.level_list,function(t){return i.id==t.option_id?(i.checked=!0,void e.levelIds.push(i.id)):void 0}),e.allLevelChecked=!1,e.setLevel=angular.copy(e.infoList.level_list)):(1==e.infoList.level_scope||"add"==e.ael)&&(i.checked=!0,e.allLevelChecked=!0,e.levelIds.push(i.id),e.levelSubList.id=i.id,e.levelSubList.name=i.name,e.setLevel.push(angular.copy(e.levelSubList)))}),e.levelList=i.data,0==e.infoList.level_list.length&&0==e.infoList.level_scope&&(e.levelIds=[],e.setLevel=[],e.levelList=[])}),console.log(e.levelList)},e.getLevel(),e.terminalIds=[],e.setTerminal=[],e.terminalSubList={},e.get_terminal_type=function(){t.dataGet("admin/system_code_admin/get_by_type/terminal_type").then(function(i){i&&(angular.forEach(i,function(i){e.infoList.terminal_list.length>0&&0==e.infoList.terminal_type_scope?(angular.forEach(e.infoList.terminal_list,function(t){return i.id==t.option_id?(i.checked=!0,void e.terminalIds.push(i.id)):void 0}),e.allTerminalChecked=!1,e.setTerminal=angular.copy(e.infoList.terminal_list)):(1==e.infoList.terminal_type_scope||"add"==e.ael)&&(i.checked=!0,e.allTerminalChecked=!0,e.terminalIds.push(i.id),e.terminalSubList.id=i.id,e.terminalSubList.name=i.name,e.setTerminal.push(angular.copy(e.terminalSubList)))}),e.setTerminalList=i,0==e.infoList.terminal_list.length&&0==e.infoList.terminal_type_scope&&(e.terminalIds=[],e.setTerminal=[],e.setTerminalList=[]),console.log("setTerminalListt"),console.log(e.setTerminalList))})},e.get_terminal_type(),e.levelSubList={},e.setLevel=[],e.selectAllLevel=function(){e.allLevelChecked?(e.levelIds=[],e.setLevel=[],angular.forEach(e.levelList,function(i){i.checked=!0,e.levelIds.push(i.id),e.levelSubList.id=i.id,e.levelSubList.name=i.name,e.setLevel.push(angular.copy(e.levelSubList))}),e.infoList.level_scope=1):(e.levelIds=[],angular.forEach(e.levelList,function(e){e.checked=!1}),e.setLevel=[],e.infoList.level_scope=0),console.log(e.setLevel)},e.selectLevel=function(i){angular.forEach(e.levelList,function(t){var o=e.levelIds.indexOf(i.id);-1===o&&t.checked&&i.id==t.id?(e.levelIds.push(t.id),e.levelSubList.id=t.id,e.levelSubList.name=t.name,e.setLevel.push(angular.copy(e.levelSubList))):-1===o||t.checked||i.id!=t.id||(e.levelIds.splice(o,1),e.setLevel.splice(o,1))}),e.allLevelChecked=e.levelList.length===e.levelIds.length,e.infoList.level_scope=e.levelList.length===e.levelIds.length?1:0,console.log(e.setLevel)},e.selectAllTerminal=function(){e.allTerminalChecked?(e.terminalIds=[],e.setTerminal=[],angular.forEach(e.setTerminalList,function(i){i.checked=!0,e.terminalIds.push(i.id),e.terminalSubList.id=i.id,e.terminalSubList.name=i.name,e.setTerminal.push(angular.copy(e.terminalSubList))}),e.infoList.terminal_type_scope=1):(e.terminalIds=[],angular.forEach(e.setTerminalList,function(e){e.checked=!1}),e.setTerminal=[],e.infoList.terminal_type_scope=0),console.log(e.setTerminal)},e.selectTerminal=function(i){angular.forEach(e.setTerminalList,function(t){var o=e.terminalIds.indexOf(i.id);-1===o&&t.checked&&i.id==t.id?(e.terminalIds.push(i.id),e.terminalSubList.id=i.id,e.terminalSubList.name=i.name,e.setTerminal.push(angular.copy(e.terminalSubList))):-1===o||t.checked||i.id!=t.id||(e.terminalIds.splice(o,1),e.setTerminal.splice(o,1))}),e.allTerminalChecked=e.setTerminalList.length===e.terminalIds.length,e.infoList.terminal_type_scope=e.setTerminalList.length===e.terminalIds.length?1:0,console.log(e.setTerminal)},e.selecteCommodityListByCategory||(e.selecteCommodityListByCategory=[]),e.getCate=function(){t.dataPost("admin/category_admin/get_categories").then(function(i){e.cateList=i.data})},e.getCate(),e.add_commodity_by_category=function(){var i=e.categoryIds.indexOf(e.infoList.category_id);-1==i?(e.categoryObject.id=e.infoList.category_id,e.categoryObject.name=$("#category").find("option:selected").text(),e.categoryIds.push(e.infoList.category_id),e.selecteCommodityListByCategory.push(angular.copy(e.categoryObject))):t.msg("e","已经添加过该分类"),console.log(e.selecteCommodityListByCategory)},e.deleteCategory=function(i){e.categoryIds.splice(i,1),e.selecteCommodityListByCategory.splice(i,1)},e.add_commodity=function(){e.title="添加免邮规格",t.modal({tempUrl:"/source/admin/tpl/modal/modal-agentAddCommodity.html",tempCtrl:"agentAddCommodityCtrl",ok:e.add,size:"lg",params:{title:e.title,infoList:e.discount,roleList:e.roleList,ael:"add"}})},e.add=function(i){if(e.set_commodity=[],"edit"==e.ael){if(e.ids=[],e.commodity_ids=[],e.commodity_list=[],angular.forEach(i,function(i){(0==e.commodity_ids.length||-1==e.commodity_ids.indexOf(i.id))&&(e.commodity_ids.push(i.id),e.commodity_list.push(i))}),""==e.selecteCommodityList||void 0==e.selecteCommodityList)e.selecteCommodityList=angular.copy(e.commodity_list);else{if(angular.forEach(e.selecteCommodityList,function(i){var t=e.commodity_ids.indexOf(i.id);if(-1!=t){for(var o=0;o<e.commodity_list.length;o++)e.commodity_list[o].id==i.id&&e.commodity_list.splice(o,1);e.commodity_ids.splice(t,1)}}),0==e.commodity_ids.length)return void t.msg("e","已经添加过该商品");angular.forEach(e.commodity_list,function(i){e.selecteCommodityList.push(i)})}angular.forEach(e.selecteCommodityList,function(i){e.ids.push(i.id)})}else"add"==e.ael&&(angular.forEach(i,function(i){(0==e.commodity_ids.length||-1==e.commodity_ids.indexOf(i.id))&&(e.commodity_ids.push(i.id),e.commodity_list.push(i))}),0!=e.selecteCommodityList.length&&angular.forEach(e.selecteCommodityList,function(i){-1!=JSON.stringify(e.commodity_list).indexOf(i.id)&&angular.forEach(e.commodity_list,function(t,o){t.id==i.id&&(e.commodity_list.splice(o,1),e.commodity_ids.splice(i.id,1))})}),angular.forEach(e.commodity_list,function(i){e.selecteCommodityList.push(angular.copy(i))}),e.idStr=e.commodity_ids.join(","));angular.forEach(e.selecteCommodityList,function(i){i.specification_center_name?i.name=i.commodity_name+"-"+i.specification_center_name+"-"+i.package_type_name:i.specification_name&&(i.name=i.commodity_name+"-"+i.specification_name+"-"+i.package_type_name),e.setCommodity.id=i.id,e.setCommodity.commodity_name=i.name,e.set_commodity.push(angular.copy(e.setCommodity))}),console.log(e.selecteCommodityList),console.log(e.set_commodity)},e.cancelCommodity=function(i,t){e.commodity_ids.splice(t.id,1),e.selecteCommodityList.splice(i,1),e.set_commodity.splice(i,1)},e.cancel=function(){i.dismiss("cancel")},e.ok=function(){if(e.infoList.terminal_list=JSON.stringify(e.setTerminal),!e.infoList.name)return void t.msg("e","名称不能为空");if(!e.infoList.role_id)return void t.msg("e","角色不能为空");if(2==e.infoList.commodity_scope&&e.selecteCommodityListByCategory.length<=0||3==e.infoList.commodity_scope&&e.set_commodity.length<=0)return void t.msg("e","请添加可使用商品");if(1==e.infoList.type){if(!e.infoList.order_cost)return void t.msg("e","请设置包邮规格");if(0==e.infoList.order_cost)return void t.msg("e","包邮规格价格不能为0")}else if(2==e.infoList.type){if(!e.infoList.order_commodity_amount)return void t.msg("e","请设置包邮规格");if(0==e.infoList.order_commodity_amount)return void t.msg("e","包邮规格商品数量不能为0")}return 1!=e.infoList.level_scope&&e.infoList.setLevel<=0?void t.msg("e","请选择添加会员"):1!=e.infoList.terminal_type_scope&&e.infoList.setTerminal<=0?void t.msg("e","请选择终端"):(angular.forEach(e.selecteCommodityListByCategory,function(e){e.option_id=angular.copy(e.id),e.option_name=angular.copy(e.name),delete e.$$hashKey}),angular.forEach(e.selecteCommodityListByCategory,function(e){delete e.id,delete e.name}),e.infoList.category_list=JSON.stringify(e.selecteCommodityListByCategory),angular.forEach(e.set_commodity,function(e){e.option_id=angular.copy(e.id),e.option_name=angular.copy(e.commodity_name?e.commodity_name:e.name)}),angular.forEach(e.set_commodity,function(e){delete e.id,delete e.commodity_name,delete e.name}),e.infoList.commodity_list=JSON.stringify(e.set_commodity),angular.forEach(e.setLevel,function(e){e.option_id=angular.copy(e.id?e.id:e.option_id),e.option_name=angular.copy(e.name?e.name:e.option_name)}),angular.forEach(e.setLevel,function(e){delete e.id,delete e.name}),e.infoList.level_list=JSON.stringify(e.setLevel),angular.forEach(e.setTerminal,function(e){e.option_id=angular.copy(e.id?e.id:e.option_id),e.option_name=angular.copy(e.name?e.name:e.option_name)}),angular.forEach(e.setTerminal,function(e){delete e.id,delete e.name}),e.infoList.terminal_list=JSON.stringify(e.setTerminal),void i.close(e.infoList))}}]);