app.directive("autoFocus",function(){return function(t,e){e[0].focus()}}),app.controller("reportListCtrl1",["$scope","_jiyin","dataToURL","$state","$stateParams","$rootScope",function(t,e,o,r,i,n){t.is_admin=n.is_admin,t.inputPage=1,t.pageSize=10,t.open=!1,t.check=!1,t.keywords="",t.start_time="",t.end_time="",t.agent_id="",t.role_id="",t.$watch("currentUser",function(o){o&&(t.role_id=n.currentUser.role_id),20==n.currentUser.role_id&&e.dataPost("admin/user_admin/get_agents").then(function(o){1==o.success?t.agents=o.data:e.msg("e",o.msg)})}),t.upload=function(){$("#upload").modal("show")},t.ok=function(){$("#upload").modal("hide")},t.$on("reportList",function(e,o){t.reportList=o}),t.$on("totalPage",function(e,o){t.totalPage=o}),t.openImport=function(){t.$broadcast("openImport",{open:!0}),$("#importModal").modal("show")},t.ImportReport=function(){t.$broadcast("importReportFlag",{open:!0}),$("#importReportModal").modal("show")},t.confirmImport=function(){t.getData(),$("#importReportModal").modal("hide")},t.closeImport=function(){$("#importModal").modal("hide")},t.deleteBatch=function(){t.$broadcast("deleteReportFlag",{open:!0}),$("#deleteReportModal").modal("show")},t.confirmReport=function(){$("#deleteReportModal").modal("hide")},t.reportList=[],t.getData=function(){e.dataPost("admin/report_admin/get_report_by_suborder/"+t.inputPage+"/"+t.pageSize,o({keywords:t.keywords,start_time:t.start_time,end_time:t.end_time,agent_id:t.agent_id})).then(function(o){if(o.success){angular.forEach(o.data,function(t){null!=t.birth&&""!=t.birth&&(t.birth=t.birth.substr(0,10))}),t.reportList=o.data,t.tempReportList=[];for(var r=0;r<t.reportList.length;r++)t.reportList[r].report_list.length>2?(t.tempReportList[r]=t.reportList[r].report_list.slice(2,t.reportList[r].report_list.length),t.reportList[r].report_list=t.reportList[r].report_list.slice(0,2)):t.tempReportList[r]=[]}else e.msg("e",o.msg);t.totalPage=o.total_page,t.totalNum=o.total_num})},t.getData(),t.search=function(){t.inputPage=1,e.dataPost("admin/report_admin/get_report_by_suborder/"+t.inputPage+"/"+t.pageSize,o({keywords:t.keywords,start_time:t.start_time,end_time:t.end_time,agent_id:t.agent_id})).then(function(o){if(o.success){angular.forEach(o.data,function(t){null!=t.birth&&""!=t.birth&&(t.birth=t.birth.substr(0,10))}),t.reportList=o.data,t.tempReportList=[];for(var r=0;r<t.reportList.length;r++)t.reportList[r].report_list.length>2?(t.tempReportList[r]=t.reportList[r].report_list.slice(2,t.reportList[r].report_list.length),t.reportList[r].report_list=t.reportList[r].report_list.slice(0,2)):t.tempReportList[r]=[]}else t.reportList=[],e.msg("e",o.msg);t.totalPage=o.total_page,t.totalNum=o.total_num})},$("#search").keydown(function(e){13==e.keyCode&&t.search()}),t.delete=function(r){var i="";i=1==r.report_status?"此报告已录入检测人信息，确定要删除吗?":"确定要删除吗?",confirm(i)&&e.dataPost("admin/report_admin/delete",o({id:r.id})).then(function(o){1==o.success?(e.msg("s","删除成功"),t.getData()):e.msg("e","删除失败")})},t.deleteReport=function(r){e.dataPost("admin/report_admin/delete_report_attachment",o({report_id:r})).then(function(o){1==o.success?(e.msg("s","删除成功"),t.getData()):e.msg("e","删除失败")})},t.push_report=function(e){for(var o=0;o<t.tempReportList[e].length;o++)t.reportList[e].report_list.push(t.tempReportList[e][o])},t.shift_report=function(e){for(var o=0;o<t.tempReportList[e].length;o++)t.reportList[e].report_list=t.reportList[e].report_list.slice(0,2)},t.download=function(t){window.open(SITE_URL+t.report_attachment)},t.$on("attachment_id",function(e,o){t.reportData.attachment_id=o}),t.edit=function(e,o){t.order=e,t.reportData=o,t.province=o.province,t.is_edit=!0,t.open=!0;var r=$("#province");r.val(t.reportData.province_code),t.searchNextLevel(r[0],t.reportData.city_code,t.reportData.district_code),$("#province").val(o.province_code),$("#reportModal").modal("show"),t.$broadcast("open",{open:t.open})},t.add=function(){t.reportData={},t.is_edit=!1,t.open=!0,$("#reportModal").modal("show"),setTimeout(function(){$("#focus_number").focus()},500),$("#focus_number")[0].focus(),t.$broadcast("open",{open:t.open})},t.download_for_template=function(t){var e=SITE_URL+"admin/report_admin/download_report_template?order_id="+t.order_id+"&order_commodity_id="+t.order_commodity_id;e+=3==t.terminal_type?"&is_online=2":"&is_online=1",window.open(e)},t.getCommos=function(){e.dataPost("admin/detection_template_admin/get_detection_template").then(function(e){t.commoLists=e.success?e.data:[]})},t.max_project=0,t.$watch("reportData.template_id",function(e){e&&angular.forEach(t.commoLists,function(o){e==o.id&&(t.max_project=o.projects.length)})}),$("#focus_number").bind("keypress",function(t){"13"==t.keyCode&&document.getElementById("project_num").focus()}),$("#project_num").bind("keypress",function(e){"13"==e.keyCode&&t.ok()}),t.is_more=!1,t.checkProjectNum=function(){t.is_more=t.reportData.project>t.max_project?!0:!1},t.has_order_id=!1,t.$watch("order.order_id",function(e){t.has_order_id=e&&""!=e?!0:!1}),t.ok=function(){var r;t.reportData.birth=$(".user-birthday").val(),r=0==t.is_edit?"admin/report_admin/add":"admin/report_admin/update",e.dataPost(r,o(t.reportData)).then(function(o){1==o.success?(e.msg("s",o.msg),t.getData(),$("#reportModal").modal("hide"),t.open=!1):e.msg("e",o.msg)})};var a=new AMap.DistrictSearch({level:"country",showbiz:!1,subdistrict:1});t.initAddress=function(){a.search("中国",function(e,o){"complete"==e&&(o.districtList.length>0?t.getAdministrativeRegion(o.districtList[0]):console.log("获取省级行政区失败"))})},t.getAdministrativeRegion=function(e,o,r){var i=e.districtList,n=e.level;if("province"===n?(nextLevel="city",$("#city").innerHTML="",$("#district").innerHTML="",$("#city").empty(),$("#city").val(""),$("#district").empty(),$("#district").val("")):"city"===n&&(nextLevel="district",$("#district").innerHTML="",$("#district").empty(),$("#district").val("")),i){i.length>0&&$("#"+i[0].level).empty();var a;a=new Option("province"==n?"--省--":"city"==n?"-- 区 --":"--省--"),a.setAttribute("value","");for(var s=0,d=i.length;d>s;s++){{var c=i[s].name,l=i[s].adcode,p=i[s].level;i[s].citycode}0==s&&(document.querySelector("#"+p).add(a),document.querySelector("#"+p).removeAttribute("disabled")),a=new Option(c),a.setAttribute("value",l),a.center=i[s].center,a.adcode=i[s].adcode,document.querySelector("#"+p).add(a)}"undefined"!=typeof o&&""!=o&&"city"==p?($("#"+p).val(o),t.searchNextLevel($("#"+p)[0],o,r)):"undefined"!=typeof r&&""!=r&&"district"==p&&$("#"+p).val(r)}else"province"==n?($("#city").attr("disabled","disabled"),$("#district").attr("disabled","disabled")):"city"==n&&$("#district").attr("disabled","disabled")},t.searchNextLevel=function(e,o,r){var i=e[e.options.selectedIndex],n=(i.text,i.adcode);o=o||"",r=r||"",a.setLevel(i.value),a.search(n,function(e,i){"complete"===e&&t.getAdministrativeRegion(i.districtList[0],o,r)})},t.initAddress(),$("#province")[0].addEventListener("change",function(){var e=this;t.searchNextLevel(e),t.reportData.province=e[e.options.selectedIndex].text,t.reportData.province_code=e[e.options.selectedIndex].value},!1),$("#city")[0].addEventListener("change",function(){var e=this;t.searchNextLevel(e),t.reportData.city=e[e.options.selectedIndex].text,t.reportData.city_code=e[e.options.selectedIndex].value},!1),$("#district")[0].addEventListener("change",function(){var e=this;t.searchNextLevel(e),t.reportData.district=e[e.options.selectedIndex].text,t.reportData.district_code=e[e.options.selectedIndex].value},!1),t.nextPage=function(){t.inputPage<t.totalPage?(t.inputPage++,t.getData()):e.msg("e","当前是最后一页")},t.previousPage=function(){t.inputPage>1?(t.inputPage--,t.getData()):e.msg("e","当前是第一页")},t.firstPage=function(){1==t.totalPage?e.msg("e","当前是第一页"):(t.inputPage=1,t.getData())},t.lastPage=function(){1==t.totalPage?e.msg("e","当前是最后一页"):(t.inputPage=t.totalPage,t.getData())};var s;t.selectPage=function(o){clearTimeout(s),s=setTimeout(function(){1==t.totalPage?e.msg("e","当前是最后一页"):(t.inputPage=o,t.getData())},500)},t.$on("error",function(e,o){t.error=o}),t.$on("importInfoMsg",function(e,o){t.importInfoMsg=o}),t.closeError=function(){$("#reportErrorModal").modal("hide"),e.msg("w",t.importInfoMsg)},t.closeData=function(){$("#reportResultModal").modal("hide"),t.getData()},t.$on("reportData",function(e,o){angular.forEach(o,function(t){t.selectSingle=!1}),t.resultData=o})}]),app.controller("reportFileUploadCtrl",["$scope","FileUploader","$modal","_jiyin","dataToURL",function(t,e,o,r,i){var n=t.uploader=new e({url:SITE_URL+"attachment/upload_report"});t.$on("open",function(t,e){1==e.open&&n.clearQueue()}),n.filters.push({name:"customFilter",fn:function(){return this.queue.length<2}}),t.upload=function(e){return n.queue.length>1?void r.msg("e","只能上传一个文件"):void r.fileMd5(e._file).then(function(o){r.dataPost("attachment/check_md5",i({md5_code:o.md5Code})).then(function(o){1==o.exist?(t.$emit("attachment_id",o.attachment_id),e.file.size=e._file.size,e.progress=100,e.isSuccess=!0,e.isUploaded=!0,e.uploader.progress+=100/n.queue.length):e.upload()})})},t.uploadAll=function(){return n.queue.length>1?void r.msg("e","只能上传一个文件"):void angular.forEach(n.queue,function(e){r.fileMd5(e._file).then(function(o){r.dataPost("attachment/check_md5",i({md5_code:o.md5Code})).then(function(o){1==o.exist?(t.$emit("attachment_id",o.attachment_id),e.file.size=e._file.size,e.progress=100,e.isSuccess=!0,e.isUploaded=!0,n.progress+=100/n.queue.length):e.upload()})})})},n.onSuccessItem=function(e,o){t.$emit("attachment_id",o.attachment_id)},t.$on("clearQueue",function(){n.clearQueue()})}]),app.controller("reportTemplateFileUploadCtrl",["$scope","FileUploader","_jiyin","dataToURL",function(t,e,o,r){var i=t.uploader=new e({url:SITE_URL+"admin/report_admin/batch_up_report_info"});t.$on("openImport",function(t,e){1==e.open&&i.clearQueue()}),i.filters.push({name:"customFilter",fn:function(){return this.queue.length<2}}),t.upload=function(t){return i.queue.length>1?void o.msg("e","只能上传一个文件"):void t.upload()},t.uploadAll=function(){return i.queue.length>1?void o.msg("e","只能上传一个文件"):void angular.forEach(i.queue,function(t){t.upload()})},i.onSuccessItem=function(e,i){1==i.success?($("#importModal").modal("hide"),1==i.all?o.msg("s",i.msg):(t.$emit("error",i.error),t.$emit("importInfoMsg",i.msg),$("#reportErrorModal").modal("show")),o.dataPost("admin/report_admin/get_report_by_page/",r({page:1,keyword:"",attachment:2,has_written:2,start_create_time:"",end_create_time:"",page_size:10,is_online:2})).then(function(e){e.success?(t.$emit("reportList",e.data),t.$emit("totalPage",e.total_page)):o.msg("s",e.msg)})):o.msg("e",i.msg)},t.$on("openImport",function(){i.clearQueue()})}]),app.controller("importReportCtrl",["$scope","FileUploader","_jiyin","dataToURL",function(t,e,o){var r=t.uploader=new e({url:SITE_URL+"admin/report_admin/batch_upload_report_info"});t.$on("importReportFlag",function(t,e){1==e.open&&r.clearQueue()}),r.filters.push({name:"customFilter",fn:function(){return this.queue.length<2}}),t.upload=function(t){return r.queue.length>1?void o.msg("e","只能上传一个文件"):void t.upload()},r.onSuccessItem=function(e,r){1==r.success?(o.msg("s",r.msg),$("#importReportModal").modal("hide"),null!=r.data&&r.data.length>0&&(t.$emit("reportData",r.data),$("#reportResultModal").modal("show"))):o.msg("e",r.msg)}}]),app.controller("deleteReportCtrl",["$scope","FileUploader","_jiyin","dataToURL",function(t,e,o){var r=t.uploader=new e({url:SITE_URL+"admin/report_admin/batch_delete_report"});t.$on("deleteReportFlag",function(t,e){1==e.open&&r.clearQueue()}),r.filters.push({name:"customFilter",fn:function(){return this.queue.length<2}}),t.upload=function(t){return r.queue.length>1?void o.msg("e","只能上传一个文件"):void t.upload()},r.onSuccessItem=function(e,r){1==r.success?(o.msg("s",r.msg),$("#deleteReportModal").modal("hide"),null!=r.data&&r.data.length>0&&(t.$emit("reportData",r.data),$("#deleteReportModal").modal("show"))):o.msg("e",r.msg)}}]);