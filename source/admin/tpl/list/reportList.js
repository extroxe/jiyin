app.directive("autoFocus",function(){return function(e,t){t[0].focus()}}),app.controller("reportListCtrl",["$scope","_jiyin","dataToURL","$state","$stateParams","$rootScope",function(e,t,o,r,n,i){e.is_admin=i.is_admin,e.reportList={},e.inputPage=1,e.keyword="",e.province="",e.list={},e.list.project_num=1,e.open=!1,e.check=!1,e.state=2,e.register_start_time="",e.register_end_time="",e.checkList=new Array,e.checkState=["全部","已提交","未提交","全部"],e.totalPage=1,e.checkNum=0,e.allCheckNum=10,e.back=function(){window.history.go(-1)},e.upload=function(){$("#upload").modal("show")},e.ok=function(){$("#upload").modal("hide")},e.$on("reportList",function(t,o){e.reportList=o}),e.$on("totalPage",function(t,o){e.totalPage=o}),e.openImport=function(){e.$broadcast("openImport",{open:!0}),$("#importModal").modal("show")},e.$watch("currentUser",function(t){t&&(e.role_id="",console.log(i.currentUser.role_id),e.role_id=i.currentUser.role_id,20==e.role_id&&e.isOnline?e.getOnlineOrderNumber():20==e.role_id&&e.getOfflineOrderNumber())}),e.ImportReport=function(){e.$broadcast("importReportFlag",{open:!0}),$("#importReportModal").modal("show")},e.confirmImport=function(){e.getData(),$("#importReportModal").modal("hide")},e.closeImport=function(){$("#importModal").modal("hide")},e.checked=function(){e.check=!e.check,e.check?angular.forEach(e.reportList,function(e){e.checked=!0}):angular.forEach(e.reportList,function(e){e.checked=!1})},e.isOnline=2==n.reportIsOnline?!1:!0,e.listcheck=function(){e.checkNum=0,angular.forEach(e.reportList,function(t){t.checked&&e.checkNum++})},e.$watch("checkNum",function(t){e.check=t<e.allCheckNum?!1:!0}),e.stateFlagSub=function(){e.state=1,e.checkState[0]=e.checkState[1]},e.stateFlagNsub=function(){e.state=0,e.checkState[0]=e.checkState[2]},e.stateFlagReset=function(){e.state=2,e.checkState[0]=e.checkState[3]},e.getData=function(){t.dataPost("admin/report_admin/get_report_by_page",o({keyword:e.keyword,attachment:e.state,has_written:2,start_create_time:e.register_start_time,end_create_time:e.register_end_time,page:e.inputPage,page_size:10,is_online:n.reportIsOnline})).then(function(t){t.success&&(angular.forEach(t.data,function(e){null!=e.birth&&""!=e.birth&&(e.birth=e.birth.substr(0,10))}),e.reportList=t.data,e.allCheckNum=e.reportList.length,angular.forEach(e.reportList,function(e){e.checked=!1})),e.totalPage=t.total_page,e.totalNum=t.total})},e.getData(),e.search=function(){e.inputPage=1,t.dataPost("admin/report_admin/get_report_by_page",o({keyword:e.keyword,attachment:e.state,has_written:2,start_create_time:e.register_start_time,end_create_time:e.register_end_time,page:e.inputPage,page_size:10,is_online:n.reportIsOnline})).then(function(o){o.success?(e.check=!1,e.reportList=o.data,e.allCheckNum=e.reportList.length,angular.forEach(e.reportList,function(e){e.checked=!1})):(e.reportList=[],t.msg("e","未查询到相关列表")),e.totalPage=o.total_page,e.totalNum=o.total})},e.update_report_status=function(){t.dataPost("admin/Erp_admin/search_report_from_erp",o({start_time:e.register_start_time,end_time:e.register_end_time})).then(function(e){e.success?t.msg("s","同步收样信息成功"):t.msg("e",e.msg)})},$("#search").keydown(function(t){13==t.keyCode&&e.search()}),e.download=function(e){window.open(SITE_URL+e.path)},e.$on("attachment_id",function(t,o){e.list.attachment_id=o}),e.add=function(){e.list={},e.list.template_id=23,e.flag=!0,e.open=!0,e.list.project_num=1,$("#reportModal").modal("show"),setTimeout(function(){$("#focus_number").focus()},500),e.isOnline=2==n.reportIsOnline?!1:!0,$("#focus_number")[0].focus(),e.$broadcast("open",{open:e.open})},e.downloadTemplate=function(){e.list={},e.list.template_id=23,e.flag=!0,e.open=!0,e.list.project_num=1,$("#reportTemplateModal").modal("show"),setTimeout(function(){$("#focus_number").focus()},500),e.isOnline=2==n.reportIsOnline?!1:!0,$("#focus_number")[0].focus(),e.$broadcast("open",{open:e.open})},e.getCommos=function(){t.dataPost("admin/detection_template_admin/get_detection_template").then(function(t){e.commoLists=t.data})},e.getOnlineOrderNumber=function(){t.dataPost("admin/order_admin/get_paid_order").then(function(t){e.OrderNumberList=t.data})},e.getOfflineOrderNumber=function(){t.dataPost("admin/order_admin/get_off_line_order").then(function(t){e.OffOrderNumberList=t.data})},e.getOrderCommodity=function(){e.isOnline?t.dataPost("admin/order_admin/show_sub_order_commodity",o({order_id:e.list.order_id})).then(function(t){e.OrderCommodityList=t.data}):t.dataPost("admin/order_admin/show_sub_commodity_name",o({order_id:e.list.order_id})).then(function(t){e.OrderCommodityList=t.data})},e.project_nums=0,e.$watch("list.template_id",function(t){t&&angular.forEach(e.commoLists,function(o){t==o.id&&(e.project_nums=o.projects.length)})}),$("#focus_number").bind("keypress",function(e){"13"==e.keyCode&&2==n.reportIsOnline&&document.getElementById("project_num").focus()}),$("#project_num").bind("keypress",function(t){"13"==t.keyCode&&2==n.reportIsOnline&&e.ok()}),e.is_more=!1,e.checkProjectNum=function(){e.is_more=e.list.project_num>e.project_nums?!0:!1},e.edit=function(t){e.list=t,e.province=t.province,e.flag=!1,e.open=!0;var o=$("#province");o.val(e.list.province_code),e.searchNextLevel(o[0],e.list.city_code,e.list.district_code),$("#province").val(t.province_code),$("#reportModal").modal("show"),e.$broadcast("open",{open:e.open})},e.delete=function(r){1==r.report_status?confirm("此报告已录入检测人信息，确定要删除吗?")&&t.dataPost("admin/report_admin/delete",o({id:r.id,number:r.number,is_online:n.reportIsOnline})).then(function(o){1==o.success?(t.msg("s","删除成功"),e.getData()):t.msg("e","删除失败")}):confirm("确定要删除吗?")&&t.dataPost("admin/report_admin/delete",o({id:r.id,number:r.number,is_online:n.reportIsOnline})).then(function(o){1==o.success?(t.msg("s","删除成功"),e.getData()):t.msg("e","删除失败")})},e.deleteReport=function(r){t.dataPost("admin/report_admin/delete_report_attachment",o({report_id:r})).then(function(o){1==o.success?(t.msg("s","删除成功"),e.getData()):t.msg("e","删除失败")})},e.has_order_id=!1,e.$watch("list.order_id",function(t){e.has_order_id=t&&""!=t?!0:!1}),e.ok=function(){var r;return e.list.birth=$(".user-birthday").val(),e.list.number?e.list.order_id&&""!=e.list.order_id?e.has_order_id&&!e.list.order_commodity_id?void t.msg("e","请选择订单商品"):(r=1==e.flag?"admin/report_admin/add":"admin/report_admin/update",void t.dataPost(r,o(e.list)).then(function(o){1==o.success?(t.msg("s",o.msg),e.getData(),$("#reportModal").modal("hide"),e.open=!1):t.msg("e",o.msg)})):void t.msg("e","订单编号不能为空"):void t.msg("e","报告编号不能为空")},e.download_for_template=function(o){if(!e.list.order_id)return void t.msg("e","请选择线下订单");if(!e.list.order_commodity_id)return void t.msg("e","请选择线下子订单");var r="";e.list.order_id&&(r+="?order_id="+e.list.order_id),e.list.order_commodity_id&&(r+="&order_commodity_id="+e.list.order_commodity_id),r+="&is_online="+o,window.open(SITE_URL+"admin/report_admin/download_report_template"+r)};var a=new AMap.DistrictSearch({level:"country",showbiz:!1,subdistrict:1});e.initAddress=function(){a.search("中国",function(t,o){"complete"==t&&(o.districtList.length>0?e.getAdministrativeRegion(o.districtList[0]):console.log("获取省级行政区失败"))})},e.getAdministrativeRegion=function(t,o,r){var n=t.districtList,i=t.level;if("province"===i?(nextLevel="city",$("#city").innerHTML="",$("#district").innerHTML="",$("#city").empty(),$("#city").val(""),$("#district").empty(),$("#district").val("")):"city"===i&&(nextLevel="district",$("#district").innerHTML="",$("#district").empty(),$("#district").val("")),n){n.length>0&&$("#"+n[0].level).empty();var a;a=new Option("province"==i?"--省--":"city"==i?"-- 区 --":"--省--"),a.setAttribute("value","");for(var c=0,s=n.length;s>c;c++){{var d=n[c].name,l=n[c].adcode,u=n[c].level;n[c].citycode}0==c&&(document.querySelector("#"+u).add(a),document.querySelector("#"+u).removeAttribute("disabled")),a=new Option(d),a.setAttribute("value",l),a.center=n[c].center,a.adcode=n[c].adcode,document.querySelector("#"+u).add(a)}"undefined"!=typeof o&&""!=o&&"city"==u?($("#"+u).val(o),e.searchNextLevel($("#"+u)[0],o,r)):"undefined"!=typeof r&&""!=r&&"district"==u&&$("#"+u).val(r)}else"province"==i?($("#city").attr("disabled","disabled"),$("#district").attr("disabled","disabled")):"city"==i&&$("#district").attr("disabled","disabled")},e.searchNextLevel=function(t,o,r){var n=t[t.options.selectedIndex],i=(n.text,n.adcode);o=o||"",r=r||"",a.setLevel(n.value),a.search(i,function(t,n){"complete"===t&&e.getAdministrativeRegion(n.districtList[0],o,r)})},e.initAddress(),$("#province")[0].addEventListener("change",function(){var t=this;e.searchNextLevel(t),e.list.province=t[t.options.selectedIndex].text,e.list.province_code=t[t.options.selectedIndex].value},!1),$("#city")[0].addEventListener("change",function(){var t=this;e.searchNextLevel(t),e.list.city=t[t.options.selectedIndex].text,e.list.city_code=t[t.options.selectedIndex].value},!1),$("#district")[0].addEventListener("change",function(){var t=this;e.searchNextLevel(t),e.list.district=t[t.options.selectedIndex].text,e.list.district_code=t[t.options.selectedIndex].value},!1),e.nextPage=function(){e.inputPage<e.totalPage?(e.check=!1,e.inputPage++,e.getData()):t.msg("e","当前是最后一页")},e.previousPage=function(){e.inputPage>1?(e.check=!1,e.inputPage--,e.getData()):t.msg("e","当前是第一页")},e.firstPage=function(){1==e.totalPage?t.msg("e","当前是第一页"):(e.check=!1,e.inputPage=1,e.getData())},e.lastPage=function(){1==e.totalPage?t.msg("e","当前是最后一页"):(e.check=!1,e.inputPage=e.totalPage,e.getData())};var c;e.selectPage=function(o){clearTimeout(c),c=setTimeout(function(){1==e.totalPage?t.msg("e","当前是最后一页"):(e.check=!1,e.inputPage=o,e.getData())},500)},e.$on("error",function(t,o){e.error=o}),e.$on("importInfoMsg",function(t,o){e.importInfoMsg=o}),e.closeError=function(){$("#reportErrorModal").modal("hide"),t.msg("w",e.importInfoMsg)},e.closeData=function(){$("#reportResultModal").modal("hide"),e.getData()},e.$on("reportData",function(t,o){angular.forEach(o,function(e){e.selectSingle=!1}),e.resultData=o}),e.reportsIds=[],e.reportData=[],e.selectAll=function(t){$(t.target).prop("checked")?(e.reportsIds=[],angular.forEach(e.resultData,function(t){e.reportsIds.push(t.report_id)}),e.reportData=e.resultData,$(".select-single").prop("checked",!0)):(e.reportsIds=[],$(".select-single").prop("checked",!1),e.reportData=[]),console.log(e.reportsIds),console.log(e.reportData)},e.selectSingle=function(t,o){if($(o.target).prop("checked")&&-1==$.inArray(t.report_id,e.reportsIds))e.reportsIds.push(t.report_id),e.reportData.push(t);else if(!$(o.target).prop("checked")&&-1!=$.inArray(t.report_id,e.reportsIds))for(var r=0;r<e.reportsIds.length;r++){var n=$.inArray(t.report_id,e.reportsIds);-1!=n&&(e.reportsIds.splice(n,1),e.reportData.splice(n,1),r--)}$(".select-single:checked").length==e.resultData.length?$(".select-all").prop("checked",!0):$(".select-all").prop("checked",!1),console.log(e.reportsIds),console.log(e.reportData)},e.coverSingle=function(t){e.coverReport(new Array(t))},e.coverData=function(){e.coverReport(e.reportData)},e.coverReport=function(r){e.submitData=angular.copy(r),angular.forEach(e.submitData,function(e){$.each(e,function(t){"report_id"!=t&&"now_attachment_id"!=t&&delete e[t]})}),confirm("确认覆盖已存在的报告信息吗")&&t.dataPost("admin/report_admin/batch_update_report",o({val:JSON.stringify(e.submitData)})).then(function(o){o.success?t.msg("s","操作成功"):t.msg("e",o.msg),e.getData()})}}]),app.controller("reportFileUploadCtrl",["$scope","FileUploader","$modal","_jiyin","dataToURL",function(e,t,o,r,n){var i=e.uploader=new t({url:SITE_URL+"attachment/upload_report"});e.$on("open",function(e,t){1==t.open&&i.clearQueue()}),i.filters.push({name:"customFilter",fn:function(){return this.queue.length<2}}),e.upload=function(t){return i.queue.length>1?void r.msg("e","只能上传一个文件"):void r.fileMd5(t._file).then(function(o){r.dataPost("attachment/check_md5",n({md5_code:o.md5Code})).then(function(o){1==o.exist?(e.$emit("attachment_id",o.attachment_id),t.file.size=t._file.size,t.progress=100,t.isSuccess=!0,t.isUploaded=!0,t.uploader.progress+=100/i.queue.length):t.upload()})})},e.uploadAll=function(){return i.queue.length>1?void r.msg("e","只能上传一个文件"):void angular.forEach(i.queue,function(t){r.fileMd5(t._file).then(function(o){r.dataPost("attachment/check_md5",n({md5_code:o.md5Code})).then(function(o){1==o.exist?(e.$emit("attachment_id",o.attachment_id),t.file.size=t._file.size,t.progress=100,t.isSuccess=!0,t.isUploaded=!0,i.progress+=100/i.queue.length):t.upload()})})})},i.onSuccessItem=function(t,o){e.$emit("attachment_id",o.attachment_id)},e.$on("clearQueue",function(){i.clearQueue()})}]),app.controller("reportTemplateFileUploadCtrl",["$scope","FileUploader","_jiyin","dataToURL",function(e,t,o,r){var n=e.uploader=new t({url:SITE_URL+"admin/report_admin/batch_up_report_info"});e.$on("openImport",function(e,t){1==t.open&&n.clearQueue()}),n.filters.push({name:"customFilter",fn:function(){return this.queue.length<2}}),e.upload=function(e){return n.queue.length>1?void o.msg("e","只能上传一个文件"):void e.upload()},e.uploadAll=function(){return n.queue.length>1?void o.msg("e","只能上传一个文件"):void angular.forEach(n.queue,function(e){e.upload()})},n.onSuccessItem=function(t,n){1==n.success?($("#importModal").modal("hide"),1==n.all?o.msg("s",n.msg):(e.$emit("error",n.error),e.$emit("importInfoMsg",n.msg),$("#reportErrorModal").modal("show")),o.dataPost("admin/report_admin/get_report_by_page/",r({page:1,keyword:"",attachment:2,has_written:2,start_create_time:"",end_create_time:"",page_size:10,is_online:2})).then(function(t){t.success?(e.$emit("reportList",t.data),e.$emit("totalPage",t.total_page)):o.msg("s",t.msg)})):o.msg("e",n.msg)},e.$on("openImport",function(){n.clearQueue()})}]),app.controller("importReportCtrl",["$scope","FileUploader","_jiyin","dataToURL",function(e,t,o){var r=e.uploader=new t({url:SITE_URL+"admin/report_admin/batch_upload_report_info"});e.$on("importReportFlag",function(e,t){1==t.open&&r.clearQueue()}),r.filters.push({name:"customFilter",fn:function(){return this.queue.length<2}}),e.upload=function(e){return r.queue.length>1?void o.msg("e","只能上传一个文件"):void e.upload()},r.onSuccessItem=function(t,r){1==r.success?(o.msg("s",r.msg),$("#importReportModal").modal("hide"),null!=r.data&&r.data.length>0&&(e.$emit("reportData",r.data),$("#reportResultModal").modal("show"))):o.msg("e",r.msg)}}]);