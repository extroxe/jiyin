app.directive("autoFocus",function(){return function(e,a){a[0].focus()}}),app.controller("orderCtrl",["$rootScope","$scope","_jiyin","dataToURL","$stateParams","$state","$filter",function(e,a,i,t,d,n,r){a.is_admin=e.is_admin,a.orderList={},a.inputPage=1,a.pageSize={},a.pageSize.page="10",a.keyword="",a.role_id=30,a.list={},a.open=!1,a.check=!1,a.state=0,a.register_start_time="",a.register_end_time="",a.checkList=new Array,a.is_agents=["全部","是","否"],a.is_agent_id=0,a.is_agent="全部",a.totalPage=1,a.status=[],a.checkNum=0,a.allCheckNum=10,a.select_all=!1,a.select_one=!1,a.checkedArray=[],a.back=function(){window.history.go(-1)},a.operation=[];var o="",s="";a.getTime=function(){o=r("date")(a.time.register_start_time,"yyyy-MM-dd"),s=r("date")(a.time.register_end_time,"yyyy-MM-dd")},a.select_all=!1,a.selectAll=function(){if(a.select_all=!a.select_all,a.select_all)angular.forEach(a.orderList,function(e){a.checkedArray.indexOf(e.id)<0&&a.checkedArray.push(e.id),e.checked=!0});else{for(var e=0;e<a.orderList.length;e++)a.checkedArray.indexOf(a.orderList[e].id)>=0&&(a.checkedArray.splice(a.checkedArray.indexOf(a.orderList[e].id),1),e--);angular.forEach(a.orderList,function(e){e.checked=!1})}},a.selectOne=function(e){angular.forEach(a.orderList,function(i){var t=a.checkedArray.indexOf(e);-1===t&&i.checked&&e==i.id?a.checkedArray.push(i.id):-1===t||i.checked||e!=i.id||a.checkedArray.splice(t,1)}),a.select_all=a.orderList.length===a.checkedArray.length},a.stateIsAgent=function(e){angular.forEach(a.is_agents,function(i,t){e==t&&(a.is_agent=i,a.is_agent_id=e)})},a.listcheck=function(){a.checkNum=0,angular.forEach(a.orderList,function(e){e.checked&&a.checkNum++})},a.getData=function(){i.dataPost("admin/order_admin/paginate/"+a.inputPage+"/"+a.pageSize.page,t({is_point:0,keyword:a.keyword,start_create_time:a.register_start_time,end_create_time:a.register_end_time,is_agent:a.is_agent_id,order_status:a.state,off_line:0})).then(function(e){if(e.success){if(a.orderList=e.data,a.role_id=e.role_id,a.tempReportList=[],a.orderList)for(var t=0;t<a.orderList.length;t++)switch(a.orderList[t].sub_order.length>2?(a.tempReportList[t]=a.orderList[t].sub_order.slice(2,a.orderList[t].sub_order.length),a.orderList[t].sub_order=a.orderList[t].sub_order.slice(0,2)):a.tempReportList[t]=[],a.operation[t]=[],a.orderList[t].status_id){case"10":a.operation[t].actionName="确认已付款";break;case"20":a.operation[t].actionName="确认发货";break;case"30":a.operation[t].actionName="确认已寄回";break;case"40":a.operation[t].actionName="确认检测";break;case"50":a.operation[t].actionName="确认已完成";break;default:a.operation[t].actionName=""}a.allCheckNum=a.orderList.length;var d=0;angular.forEach(a.orderList,function(e){return-1!=a.checkedArray.indexOf(e.id)?(e.checked=!0,void d++):void(e.checked=!1)}),a.select_all=d===a.orderList.length}else a.orderList=[],a.select_all=!1,i.msg("e",e.msg);a.totalPage=e.total_page,a.total_count=e.total_count})},a.getData(),i.dataGet("admin/express_admin/get_all_express_company").then(function(e){a.trackingCompanyList=e.success?e.data:[]}),a.deliveryModal=function(e){a.delivery_order_id=e,$("#deliveryModal").modal("show")},a.deliveryData={tracking_company:1},a.delivery=function(e){return e.tracking_company?e.tracking_number?void i.dataPost("admin/order_admin/delivery_order",t({order_id:a.delivery_order_id,tracking_company:e.tracking_company,tracking_number:e.tracking_number})).then(function(e){e.success?(a.getData(),$("#deliveryModal").modal("hide"),i.msg("s",e.msg)):i.msg("e",e.msg)}):void i.msg("e","请填写快递编号"):void i.msg("e","请选择快递公司")},a.modifyOrderStatus=function(e,d){confirm(d)&&i.dataPost("admin/order_admin/modify_order",t({order_id:e})).then(function(e){e.success?(a.getData(),i.msg("s",e.msg)):i.msg("e",e.msg)})},$("#search").keydown(function(e){13==e.keyCode&&a.getData()}),a.search=function(){a.getData()},a.Jprintf=function(){$("#orderDetail").print({globalStyles:!0,mediaPrint:!1,stylesheet:SITE_URL+"source/admin/css/ordinaryList.css",noPrintSelector:"#closeOrderDetail, #printBtn, #order_footer",iframe:!0,append:null,prepend:null,manuallyCopyFormValues:!0,deferred:$.Deferred()})},$(window).resize(function(){$(".modal .modal-header").width()<="640"?$(".assaying span:last-child").css("margin-top","0"):$(".assaying span:last-child").css("margin-top","23px")}),a.searchOrderByStatus=function(e){a.state=e,a.getData()},i.dataGet("admin/order_admin/get_all_order_status").then(function(e){a.status=e.success?e.data:[]}),a.download=function(){if(a.checkedArray.length<=0)return void i.msg("e","请选择需要导出订单");var e="?";0!=a.checkedArray.length&&(e+="&order_id="+a.checkedArray.join("_")),e+="&is_online=1",window.open(SITE_URL+"admin/order_admin/download_order"+e)},a.exinfo=function(e){i.dataGet("admin/order_admin/show_express_info_by_order_id/"+e.id).then(function(e){1==e.success?($("#list").modal("show"),a.exinfo=e.data.Traces):i.msg("e",e.msg)})},a.cancel=function(e){$(e).modal("hide")},a.push_report=function(e){for(var i=0;i<a.tempReportList[e].length;i++)a.orderList[e].sub_order.push(a.tempReportList[e][i])},a.shift_report=function(e){for(var i=0;i<a.tempReportList[e].length;i++)a.orderList[e].sub_order=a.orderList[e].sub_order.slice(0,2)},a.editList=function(e){a.title="编辑数据",i.modal({tempUrl:"/source/admin/tpl/modal/modal-orderList.html",tempCtrl:"modalOrderCtrl",ok:a.edit,size:"lg",params:{title:a.title,infoList:e,ael:"edit",isPoint:!1}})},a.edit=function(e){i.dataPost("admin/order_admin/update",t(e)).then(function(e){1==e.success?(i.msg("s",e.msg),a.getData()):i.msg("e",e.msg)})},a.lookSub=function(e){n.go("app.subOrderList",{id:e.id,type:"ord"})},$(document).on("click","#operation li",function(){$(this).addClass("active").siblings().removeClass("active")}),a.getOrderDetailModal=function(e){a.order_status_id=e.status_id,a.notPaidValue=0,a.paidValue=0,a.deliveredValue=0,a.sentbackValue=0,a.assayingValue=0,$("#orderDetail").modal("show"),$("#closeOrderDetail").show(),$("#printBtn").show(),$("#order_footer").show(),a.orderDetail=angular.copy(e),setTimeout(function(){a.$apply(function(){"10"==e.status_id?($("div.not_paid").find(".node").addClass("active").siblings("div").find(".node").removeClass("active"),$("div.not_paid").siblings("div").find(".node").removeClass("active"),a.notPaidValue=50):"20"==e.status_id?($("div.paid").find(".node").addClass("active").siblings("div").find(".node").removeClass("active").prevAll(".node").addClass("active"),$("div.paid").siblings("div").find(".node").removeClass("active"),$("div.paid").prevAll("div").find(".node").addClass("active"),a.notPaidValue=100,a.paidValue=50):"30"==e.status_id?($("div.delivered").find(".node").addClass("active").siblings("div").find(".node").removeClass("active").prevAll(".node").addClass("active"),$("div.delivered").siblings("div").find(".node").removeClass("active"),$("div.delivered").prevAll("div").find(".node").addClass("active"),a.notPaidValue=100,a.paidValue=100,a.deliveredValue=50):"40"==e.status_id?($("div.sentback").find(".node").addClass("active").siblings("div").find(".node").removeClass("active").prevAll(".node").addClass("active"),$("div.sentback").siblings("div").find(".node").removeClass("active"),$("div.sentback").prevAll("div").find(".node").addClass("active"),a.notPaidValue=100,a.paidValue=100,a.deliveredValue=100,a.sentbackValue=50):"50"==e.status_id?($("div.assaying").find(".node").eq(0).addClass("active").siblings("div").find(".node").removeClass("active").prevAll(".node").addClass("active"),$("div.assaying").siblings("div").find(".node").removeClass("active"),$("div.assaying").prevAll("div").find(".node").addClass("active"),a.notPaidValue=100,a.paidValue=100,a.deliveredValue=100,a.sentbackValue=100,a.assayingValue=50):($("div.order-progress").find(".node").addClass("active"),a.notPaidValue=100,a.paidValue=100,a.deliveredValue=100,a.sentbackValue=100,a.assayingValue=100)})},300)},a.modifyAmountModal=function(e){$("#modifyAmount").modal("show"),$("#modify_amount").val(e.payment_amount),$("#modify_reason").val(e.modify_reason),a.modifyOrder=e},a.modifyAmount=function(e){var d=$("#modify_amount").val(),n=$("#modify_reason").val();return d?n?void i.dataPost("admin/order_admin/modify_order_amount",t({order_id:e,modify_amount:d,modify_reason:n})).then(function(e){1==e.success?(i.msg("s",e.msg),$("#modifyAmount").modal("hide"),a.getData()):i.msg("e",e.msg)}):void i.msg("e","请输入修改金额的原因"):void i.msg("e","请输入优惠的金额")},a.cancelOrderModal=function(e){a.cancelOrderData=e,$("#cancelOrder").modal("show")},a.cancelOrder=function(e){i.dataPost("admin/order_admin/cancel_order",t({order_id:e.id,reason:e.reason})).then(function(e){1==e.success?(i.msg("s","取消订单成功"),$("#cancelOrder").modal("hide"),a.getData()):i.msg("e",e.msg)})},a.nextPage=function(){a.inputPage<a.totalPage?(a.check=!1,a.inputPage++,a.getData()):i.msg("e","当前是最后一页")},a.previousPage=function(){a.inputPage>1?(a.check=!1,a.inputPage--,a.getData()):i.msg("e","当前是第一页")},a.firstPage=function(){1==a.totalPage?i.msg("e","当前是第一页"):(a.check=!1,a.inputPage=1,a.getData())},a.lastPage=function(){1==a.totalPage?i.msg("e","当前是最后一页"):(a.check=!1,a.inputPage=a.totalPage,a.getData())},a.selectPage=function(e){1==a.totalPage?i.msg("e","当前是最后一页"):(a.check=!1,a.inputPage=e,a.getData())}}]);